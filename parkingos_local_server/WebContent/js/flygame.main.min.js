function startGame(){data=Utils.getData(),game=new Phaser.Game("100%","100%",1,"game_div"),coreState=new PhaserGame(data),game.state.add("Game",coreState,!0)}function resumeGame(){Utils.isScore=!1,coreState.weapon.bulletCount>0||Utils.noBullets()}var Utils,Bullet,Weapon,PlanePathFactory,PaperPlane,Planes,SizeUtils,PhaserGame,game,coreState,data,My={};My.debug=!1,My.follow=!1,My.path=!1,Utils={},Utils.KEY_FLY_BIRD="fly_bird",Utils.KEY_PLANE_EMPTY="plane_empty",Utils.KEY_PLANE_CASH="plane_cash",Utils.KEY_PLANE_GIFT="plane_gift",Utils.KEY_PLANE_TICKET="plane_ticket",Utils.isFire=!1,Utils.isTween=!1,Utils.isBullet=!1,Utils.speedScale=1,Utils.isDebug=!1,Utils.isScore=!1,Utils.getData=function(){if(!Utils.isDebug)return getData();var a={bullet_count:5,plane_empty:0,plane_gift:0,plane_ticket:0,plane_cash:0,fly_bird:!0};return a},Utils.noBullets=function(){Utils.isDebug||noBullets()},Utils.getScroe=function(a,b,c){Utils.isDebug||getScroe(b,c)},Utils.hitEmpty=function(){Utils.isDebug||hitEmpty()},Utils.getTargetLeftTopPoint=function(a){var b={x:0,y:0};return b.x=a.x-a.width/2,b.y=a.y-a.height/2,b},Utils.getTargetRightTopPoint=function(a){var b={x:0,y:0};return b.x=a.x+a.width/2,b.y=a.y-a.height/2,b},Utils.clearArray=function(a){for(;a.length>0;)a.pop()},Bullet=function(a,b){Phaser.Sprite.call(this,a,0,0,b),a.physics.arcade.enableBody(this),this.anchor.set(.5),this.checkWorldBounds=!0,this.outOfBoundsKill=!0,this.exists=!1,this.isFly=!1,this.oldY=0,this.oldX=0,this.currentAngle=0,this.currentDistance=0,this.maxDistance=150,this.baseSpeed=580,this.tspeed=1e3},Bullet.prototype=Object.create(Phaser.Sprite.prototype),Bullet.prototype.constructor=Bullet,Bullet.prototype.show=function(a){return this.reset(a.x,a.y),this.body.gravity.y=0,this.rotation=0,this.isFly=!1,Utils.isFire=!1,Utils.isBullet=!0,this.oldX=a.x,this.oldY=a.y,this.currentAngle=Math.PI/2,this.currentDistance=0,this.body.setSize(this.width,this.height,-4,-4),this},Bullet.prototype.fire=function(){if(this.currentAngle<Math.PI/6||this.currentAngle>5*Math.PI/6||this.currentDistance<10)return!1;this.body.gravity.y=900*Utils.speedScale,this.isFly=!0,Utils.isFire=!0;var a=this.baseSpeed+this.currentDistance*this.tspeed/this.maxDistance;return a*=Utils.speedScale,this.game.physics.arcade.velocityFromRotation(this.currentAngle,-a,this.body.velocity),!0},Bullet.prototype.move=function(a,b){var d,c=this.game.math.angleBetweenPoints(a,b);c<Math.PI/6||c>5*Math.PI/6||(this.currentAngle=c,d=this.game.math.distance(a.x,a.y,b.x,b.y),d=1*d/3,d=Math.min(d,this.maxDistance),this.currentDistance=d,this.x=this.oldX+Math.cos(c)*d,this.y=this.oldY+Math.sin(c)*d,this.rotation=c-Math.PI/2)},Bullet.prototype.update=function(){},Weapon={},Weapon.SingleBullet=function(a,b){Phaser.Group.call(this,a,a.world,"SingleBullet",!1,!0,Phaser.Physics.ARCADE),this.cacheBullet=null,this.bulletShowPoint={x:0,y:0},this.showCallback=function(){},this.showCallbackContext=null,this.bulletCount=b;var c=new Bullet(a,"bullet");return this.add(c,!0),this.cacheBullet=c,this.bullet=c,this.cacheBullet.events.onKilled.add(function(){Utils.isBullet=!1,this.bulletCount--,Utils.isTween||this.show()},this),this},Weapon.SingleBullet.prototype=Object.create(Phaser.Group.prototype),Weapon.SingleBullet.prototype.constructor=Weapon.SingleBullet,Weapon.SingleBullet.prototype.fire=function(){return this.checkHasBulletFly()||null==this.cacheBullet?void 0:this.cacheBullet.fire()},Weapon.SingleBullet.prototype.move=function(a,b){null!=this.cacheBullet&&this.cacheBullet.move(a,b)},Weapon.SingleBullet.prototype.show=function(){return this.cacheBullet=this.getFirstExists(!1),null==this.cacheBullet||this.bulletCount<=0?(this.bulletCount=0,this.cacheBullet=null,Utils.isScore||Utils.noBullets(this.game)):this.cacheBullet.show(this.bulletShowPoint),this.showCallback.call(this.showCallbackContext,this.bulletCount),this.cacheBullet},Weapon.SingleBullet.prototype.checkHasBulletFly=function(){return Utils.isFire},Weapon.SingleBullet.prototype.setShowPoint=function(a){this.bulletShowPoint.x=a.x,this.bulletShowPoint.y=a.y},Weapon.SingleBullet.prototype.setShowCallback=function(a,b){this.showCallback=a,this.showCallbackContext=b},Weapon.SingleBullet.prototype.setBulletEmptyCallback=function(a,b){this.bulletEmptyCallback=a,this.bulletEmptyCallbackContext=b},PlanePathFactory=function(a){var b,c,d;for(this.baseY=200*Utils.speedScale,this.templatePoint=[],this.width=a.width,this.ty=60*Utils.speedScale,this.widthCount=9,b=this.width/(this.widthCount-1),this.templatePoint[-1]=new Array,c=-4;c<this.widthCount+4;c++)d={x:c*b,y:this.baseY-this.ty},this.templatePoint[-1][c]=d;for(this.templatePoint[0]=new Array,c=-4;c<this.widthCount+4;c++)d={x:c*b,y:this.baseY},this.templatePoint[0][c]=d;for(this.templatePoint[1]=new Array,c=-4;c<this.widthCount+4;c++)d={x:c*this.width/(this.widthCount-1),y:this.baseY+this.ty},this.templatePoint[1][c]=d},PlanePathFactory.prototype.constructor=PlanePathFactory,PlanePathFactory.prototype.createPath=function(a){var c,d,b={x:[],y:[],paths:[]};for(c=0;c<a.v.length;c++)d=this.templatePoint[a.v[c]][a.h[c]],b.x[c]=d.x,b.y[c]=d.y;return b},PlanePathFactory.prototype.getLevelPath=function(a,b,c){var f,g,h,i,j,k,d={x:b.x.slice(0),y:b.y.slice(0),paths:b.paths.slice(0)},e=c*this.ty;for(f=0;f<d.y.length;f++)d.y[f]+=e;if(My.path)for(g=0,h=1/this.width,f=0;1>f;f+=h)i=a.math.catmullRomInterpolation(d.x,f),j=a.math.catmullRomInterpolation(d.y,f),k={x:i,y:j,angle:0},g>0&&(k.angle=a.math.angleBetweenPoints(d.paths[g-1],k)),d.paths.push(k),g++;return d},PaperPlane=function(a,b,c,d){return Phaser.Sprite.call(this,a,0,0,b),this.anchor.set(.5),a.physics.arcade.enableBody(this),this.exists=!1,this.pi=0,this.path=null,this.name=b,this.lastPoint=null,this.speed=c||1,this.pathCount=a.width/this.speed,this.level=d,this},PaperPlane.prototype=Object.create(Phaser.Sprite.prototype),PaperPlane.prototype.constructor=PaperPlane,PaperPlane.prototype.update=function(){if(null!=this.path){var a=this.game.math.catmullRomInterpolation(this.path.x,this.pi/this.pathCount),b=this.game.math.catmullRomInterpolation(this.path.y,this.pi/this.pathCount),c={x:a,y:b},d=null===this.lastPoint?0:this.game.math.angleBetweenPoints(this.lastPoint,c);this.lastPoint=c,this.x=a,this.y=b,this.pi>this.pathCount/2?this.name==Utils.KEY_FLY_BIRD?this.animations.play("left",10,!0):(this.frame=1,this.rotation=d-Math.PI):this.name==Utils.KEY_FLY_BIRD?this.animations.play("right",10,!0):(this.frame=0,this.rotation=d),this.pi++,this.pi>=this.pathCount&&(this.pi=0)}},PaperPlane.prototype.drawPath=function(a){var b;for(b=0;b<this.path.paths.length;b++)a.rect(this.path.paths[b].x,this.path.paths[b].y,1,1,"#6A1B9A");for(b=0;b<this.path.x.length;b++)a.rect(this.path.x[b]-3,this.path.y[b]-3,6,6,"rgba(255, 0, 0, 1)")},PaperPlane.prototype.show=function(a){this.reset(0,0),this.path=a,this.pi=this.game.rnd.integerInRange(this.pathCount/4,3*this.pathCount/4),this.body.setSize(this.width/2,this.height/2,0,0),this.name==Utils.KEY_FLY_BIRD&&(this.animations.add("left",[0,1,2]),this.animations.add("right",[3,4,5])),this.events.onKilled.add(this.killCallback,this)},PaperPlane.prototype.killCallback=function(){Utils.clearArray(this.path.paths),Utils.clearArray(this.path.x),Utils.clearArray(this.path.y),this.path=null},Planes=function(a,b){return Phaser.Group.call(this,a,a.world,"SingleBullet",!1,!0,Phaser.Physics.ARCADE),this.pathFactory=new PlanePathFactory(a),this.paths=new Array,this.addPlanes(b),this.initPath(),this},Planes.prototype=Object.create(Phaser.Group.prototype),Planes.prototype.constructor=Planes,Planes.prototype.addPlanes=function(a,b){var c,d;if(a.fly_bird&&(this.birdPlane=new PaperPlane(game,Utils.KEY_FLY_BIRD,1,0),this.add(this.birdPlane,!0)),a.plane_cash>0)for(d=0;d<a.plane_cash;d++)c=new PaperPlane(game,Utils.KEY_PLANE_CASH,2,0),this.add(c,!0);if(a.plane_gift>0)for(d=0;d<a.plane_gift;d++)c=new PaperPlane(game,Utils.KEY_PLANE_GIFT,1.5,1),this.add(c,!0);if(c=new PaperPlane(game,Utils.KEY_PLANE_EMPTY,1,1),this.add(c,!0),a.plane_ticket>0)for(d=0;d<a.plane_ticket;d++)c=new PaperPlane(game,Utils.KEY_PLANE_TICKET,1.2,2),this.add(c,!0);if(c=new PaperPlane(game,Utils.KEY_PLANE_EMPTY,.8,3),this.add(c,!0),a.plane_empty>0)for(d=0;d<a.plane_empty-2;d++)c=0==d%2?new PaperPlane(game,Utils.KEY_PLANE_EMPTY,1,4):new PaperPlane(game,Utils.KEY_PLANE_EMPTY,.8,5),this.add(c,!0);b&&this.show(!0)},Planes.prototype.initPath=function(){var b,d,e,a=[{v:[0,-1,1,-1,1,-1,0,1,-1,1,-1,1,0],h:[-1,0,2,4,6,8,9,8,6,4,2,0,-1]},{v:[0,-1,1,-1,0,1,-1,1,0],h:[-1,1,4,7,9,7,4,1,-1]},{v:[0,-1,1,-1,0,1,-1,1,0],h:[-1,0,4,8,9,8,4,0,-1]},{v:[0,-1,1,-1,0,1,-1,1,0],h:[-1,0,5,8,9,8,3,0,-1]},{v:[0,-1,1,-1,0,1,-1,1,0],h:[-1,0,6,8,9,8,2,0,-1]},{v:[0,-1,1,-1,1,-1,1,0],h:[-1,0,7,8,9,2,1,-1]},{v:[0,-1,1,0,-1,1,0],h:[-1,0,8,9,8,0,-1]},{v:[0,-1,0,-1,1,-1,0,1,0,1,-1,1,0],h:[-1,0,1,2,5,8,9,8,7,6,3,1,-1]},{v:[0,-1,1,-1,1,0,-1,1,0,1,0],h:[-1,1,2,4,8,9,7,5,4,3,-1]}],c=a.length;for(b=0;c>b;b++)d=a[b],this.paths.push(this.pathFactory.createPath(d));e={v:[0,-1,0,-1,0,-1,0,-1,0,-1,0],h:[-4,-2,1,5,8,12,8,5,1,-2,-4]},this.paths[-1]=this.pathFactory.createPath(e),Utils.clearArray(this.pathFactory.templatePoint)},Planes.prototype.show=function(a){var b,f,g,h,c=-1,d=this.paths.length,e=-1;for(c=this.length,f=0;c>f;f++)g=this.getChildAt(f),a&&g.exists||(e=this.game.rnd.integerInRange(0,d-1),Utils.KEY_FLY_BIRD==g.name&&(e=-1),h=g.level,b=this.pathFactory.getLevelPath(this.game,this.paths[e],h),g.show(b))},Planes.prototype.drawPath=function(a){for(var b=0;b<this.length;b++)this.getChildAt(b).exists&&this.getChildAt(b).drawPath(a)},SizeUtils=function(a){this.W=a.width,this.H=a.height,this.halfW=this.W/2,this.halfH=this.H/2,this.scalex=1/this.W,this.scaley=1/this.H,this.slingshotX=this.halfW,this.slingshotY=this.H-this.getRealY(300),this.halfPI=Math.PI/2,this.planeCountX=this.getRealX(60),this.planeCountY=this.getRealY(60),this.planeCountHintX=this.getRealX(130),this.planeCountHintY=this.getRealY(50),this.personCountX=this.getRealX(260),this.personCountY=this.planeCountY,this.personCountHintX=this.getRealX(330),this.personCountHintY=this.planeCountHintY,this.bulletCountX=this.planeCountX,this.bulletCountY=this.H-this.getRealY(50),this.bulletCountHintX=this.getRealX(150),this.bulletCountHintY=this.bulletCountY,this.maxDistance=200},SizeUtils.prototype.constructor=SizeUtils,SizeUtils.prototype.getRealX=function(a){return this.scalex*a*this.W},SizeUtils.prototype.getRealY=function(a){return this.scaley*a*this.H},PhaserGame=function(a){Phaser.State.call(this),this.data=a,this.sizeutils=null,this.speed=300,this.planes=null,this.weapon=null,this.msg="",this.t,this.p1Text,this.moveMaxDistance=200,this.moveDistance=0,this.lastY=0,this.firstY=0,this.p1=null,this.bmp=null,this.g=null,this.slingshot=null,this.cloth=null,this.leftPoint=null,this.rightPoint=null,this.targetPoint={},this.templateTargetPoint={},this.showTween=!1,this.bulletCountHint=null},PhaserGame.prototype=Object.create(Phaser.State.prototype),PhaserGame.prototype.constructor=PaperPlane,PhaserGame.prototype={init:function(){this.game.renderer.renderSession.roundPixels=!0,this.physics.startSystem(Phaser.Physics.ARCADE),this.game.stage.backgroundColor="#204090"},preload:function(){this.load.image("bg","images/flygame/bg.png"),this.load.image("slingshot","images/flygame/slingshot.png"),this.load.image("bullet","images/flygame/bullet.png"),this.load.spritesheet(Utils.KEY_FLY_BIRD,"images/flygame/birdsheet.png",138,138,6),this.load.spritesheet(Utils.KEY_PLANE_EMPTY,"images/flygame/plane_empty.png",116,59,2),this.load.spritesheet(Utils.KEY_PLANE_CASH,"images/flygame/plane_cash.png",116,59,2),this.load.spritesheet(Utils.KEY_PLANE_GIFT,"images/flygame/plane_gift.png",116,59,2),this.load.spritesheet(Utils.KEY_PLANE_TICKET,"images/flygame/plane_ticket.png",116,59,2),this.load.image("bullet_count","images/flygame/bullet_count.png"),this.load.image("plane_count","images/flygame/plane_count.png"),this.load.image("cloth","images/flygame/cloth.png"),this.load.image("person","images/flygame/person.png")},init:function(){this.p1=this.game.input.pointer1},create:function(){var b,a=this.add.image(0,0,"bg");a.scale.x=this.game.width/a.width,a.scale.y=this.game.height/a.height,this.sizeutils=new SizeUtils(this.game),this.slingshot=this.add.image(this.sizeutils.slingshotX,this.sizeutils.slingshotY,"slingshot"),this.slingshot.anchor.set(.5),this.leftPoint=Utils.getTargetLeftTopPoint(this.slingshot),this.rightPoint=Utils.getTargetRightTopPoint(this.slingshot),this.templateTargetPoint.x=this.targetPoint.x=this.sizeutils.slingshotX,this.templateTargetPoint.y=this.targetPoint.y=this.sizeutils.slingshotY-this.sizeutils.getRealY(50),this.templateTargetPoint.currentAngle=this.targetPoint.currentAngle=this.sizeutils.halfPI,this.add.image(this.sizeutils.bulletCountX,this.sizeutils.bulletCountY,"bullet_count").anchor.set(.5),this.bulletCountHint=this.add.text(this.sizeutils.bulletCountHintX,this.sizeutils.bulletCountHintY,"2",{font:"40pt verdana",fill:"#000",fontWeight:"600"}),this.bulletCountHint.anchor.set(.5,.5),this.bmp=this.add.bitmapData(this.game.width,this.game.height),this.bmp.addToWorld(),this.cloth=this.add.sprite(0,0,"cloth"),this.cloth.anchor.set(.5),this.g=this.add.graphics(0,0),b=this.targetPoint.y,Utils.speedScale=(b/1400).toFixed(2),console.log("speedScale = "+Utils.speedScale),console.log("speedScale = "+b),this.planes=new Planes(this.game,this.data),this.planes.show(),My.path&&this.planes.drawPath(this.bmp),this.weapon=new Weapon.SingleBullet(this.game,this.data.bullet_count),this.weapon.setShowPoint(this.targetPoint),this.weapon.setShowCallback(this.showCallback,this),this.weapon.show(),this.input.onDown.add(function(){},this),this.input.onUp.add(function(){if(!(this.weapon.checkHasBulletFly()||this.p1.position.y<this.sizeutils.halfH||this.p1.positionDown.y<this.sizeutils.halfH||!this.weapon.fire(this.p1.positionDown,this.p1.position))){var a=this.add.tween(this.targetPoint);this.showTween=!0,Utils.isTween=!0,this.preTween(a)}},this),this.game.time.advancedTiming=!0,this.t=this.game.add.text(316,66,"",{font:"26pt Helvetica",fill:"#000"})},update:function(){Utils.isFire&&(console.log("check overlap"),this.game.physics.arcade.overlap(this.planes,this.weapon,this.overlapCallback,null,this))},render:function(){if(this.bulletCountHint.text=""+this.weapon.bulletCount,this.p1.active&&this.p1.y>this.sizeutils.halfH&&this.p1.positionDown.y>this.sizeutils.halfH&&(this.weapon.checkHasBulletFly()||(this.weapon.move(this.p1.positionDown,this.p1.position),null!=this.weapon.cacheBullet&&(this.targetPoint.x=this.weapon.cacheBullet.x,this.targetPoint.y=this.weapon.cacheBullet.y,this.targetPoint.currentAngle=this.weapon.cacheBullet.currentAngle,this.targetPoint.distance=this.weapon.cacheBullet.currentDistance,this.drawRubberBand()))),this.showTween&&this.drawRubberBand(),Utils.isDebug&&(this.t.text="fps:"+this.game.time.fps),My.debug)for(var a=0;a<this.planes.length;a++)this.game.debug.body(this.planes.getChildAt(a))},drawRubberBand:function(){var f,g,h,a=this.g,b=this.targetPoint,c=this.leftPoint,d=this.rightPoint,e=b.currentAngle-Math.PI/2;a.clear(),a.beginFill(6953882),f=this.weapon.bullet.height/2+this.cloth.height/2-5,g=b.x+f*Math.cos(b.currentAngle),h=b.y+f*Math.sin(b.currentAngle),a.endFill(),this.game.context.lineCap="round",this.game.context.lineJoin="round",a.lineStyle(10,9660682),a.beginFill(9660682),f=this.cloth.width/2-8,a.moveTo(c.x+14,c.y+33),a.lineTo(g-f*Math.cos(e),h-f*Math.sin(e)),a.moveTo(d.x-13,d.y+33),a.lineTo(g+f*Math.cos(e),h+f*Math.sin(e)),a.endFill(),this.cloth.rotation=e,this.cloth.x=g,this.cloth.y=h},overlapCallback:function(a,b){var c=a.name;a.kill(),b.kill(),c==Utils.KEY_PLANE_EMPTY?Utils.hitEmpty():(Utils.isScore=!0,Utils.getScroe(this.game,c,this.weapon.bulletCount)),this.planes.show(!0)},showCallback:function(){this.drawRubberBand()},preTween:function(a){var b=this.weapon.cacheBullet.currentDistance,c=this.weapon.cacheBullet.maxDistance,d=2e3*(b/c)+2e3,e={x:this.sizeutils.halfW,y:Utils.getTargetLeftTopPoint(this.slingshot).y+20},f={x:0,y:0},g={x:0,y:0},h={x:0,y:0};f.x=e.x-(this.targetPoint.x-e.x),f.y=e.y-(this.targetPoint.y-e.y),g.x=e.x+(this.targetPoint.x-e.x)/2,g.y=e.y+(this.targetPoint.y-e.y)/2,h.x=e.x-(this.targetPoint.x-e.x)/2,h.y=e.y-(this.targetPoint.y-e.y)/2,a.to({x:[f.x,g.x,h.x,e.x,this.templateTargetPoint.x],y:[f.y,g.y,h.y,e.y,this.templateTargetPoint.y]},d,null,!0),a.onComplete.add(function(){this.targetPoint.x=this.templateTargetPoint.x,this.targetPoint.y=this.templateTargetPoint.y,this.targetPoint.currentAngle=this.templateTargetPoint.currentAngle,this.showTween=!1,Utils.isTween=!1,Utils.isBullet||this.weapon.show(),this.drawRubberBand()},this)}},Utils.isDebug&&startGame();